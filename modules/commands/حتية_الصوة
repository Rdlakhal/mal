const fs = require("fs");
const axios = require("axios");

const dataPath = './groupImageData.json';

module.exports.config = {
    name: "Ø­Ù…Ø§ÙŠØ©_Ø§Ù„ØµÙˆØ±Ø©",
    version: "1.0.0",
    hasPermssion: 0,
    credits: "HungCatMoi",
    description: "Ù‚Ù… Ø¨Ø­Ù…Ø§ÙŠØ© ØµÙˆØ±Ø© Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±",
    commandCategory: "Box",
    usages: "Ø­Ù…Ø§ÙŠØ©_Ø§Ù„ØµÙˆØ±Ø© [ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„]",
    cooldowns: 0,
    dependencies: []
};

module.exports.onLoad = function({ api }) {
    // Ensure groupImageData.json exists
    if (!fs.existsSync(dataPath)) {
        fs.writeFileSync(dataPath, JSON.stringify({}));
    }

    // Set up listener for group image changes
    api.listenMqtt(async (error, message) => {
        if (message.type === "event" && message.logMessageType === "log:thread-image") {
            const data = JSON.parse(fs.readFileSync(dataPath));
            if (data[message.threadID] && data[message.threadID].enabled) {
                const newImageUrl = message.logMessageData.imageUrl;
                const originalImagePath = __dirname + `/cache/${message.threadID}_original.png`;
                if (newImageUrl !== originalImagePath) {
                    api.changeGroupImage(fs.createReadStream(originalImagePath), message.threadID, () => {
                        api.sendMessage(`ğŸš¨ ØªÙ… ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ù‚ÙØ¨ÙÙ„ Ø£Ø­Ø¯Ù‡Ù…ØŒ ÙˆÙ„ÙƒÙ† ØªÙ… Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠØ©.`, message.threadID);
                    });
                }
            }
        }
    });
};

module.exports.run = async function({ api, event, args }) {
    const subCommand = args[0];
    let data = JSON.parse(fs.readFileSync(dataPath));

    if (!data[event.threadID]) {
        data[event.threadID] = { enabled: false, originalImagePath: null };
    }

    if (subCommand === "ØªÙØ¹ÙŠÙ„") {
        if (event.type !== "message_reply") {
            return api.sendMessage("âŒ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.", event.threadID, event.messageID);
        }
        if (!event.messageReply.attachments || event.messageReply.attachments.length == 0) {
            return api.sendMessage("âŒ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.", event.threadID, event.messageID);
        }
        if (event.messageReply.attachments.length > 1) {
            return api.sendMessage(`âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·!`, event.threadID, event.messageID);
        }

        const imageUrl = event.messageReply.attachments[0].url;
        const originalImagePath = __dirname + `/cache/${event.threadID}_original.png`;
        const imageBuffer = (await axios.get(imageUrl, { responseType: 'arraybuffer' })).data;
        fs.writeFileSync(originalImagePath, Buffer.from(imageBuffer, 'utf-8'));

        data[event.threadID] = { enabled: true, originalImagePath: originalImagePath };
        fs.writeFileSync(dataPath, JSON.stringify(data));

        api.sendMessage("ğŸ”’ Ø­Ù…Ø§ÙŠØ© ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙØ¹Ù„Ø©.", event.threadID, event.messageID);
    } else if (subCommand === "ØªØ¹Ø·ÙŠÙ„") {
        data[event.threadID].enabled = false;
        fs.writeFileSync(dataPath, JSON.stringify(data));
        api.sendMessage("ğŸ”“ Ø­Ù…Ø§ÙŠØ© ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹Ø·Ù„Ø©.", event.threadID, event.messageID);
    } else {
        api.sendMessage("â— Ø§Ø³ØªØ®Ø¯Ø§Ù… ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… 'Ø­Ù…Ø§ÙŠØ©_Ø§Ù„ØµÙˆØ±Ø© ØªÙØ¹ÙŠÙ„' Ø£Ùˆ 'Ø­Ù…Ø§ÙŠØ©_Ø§Ù„ØµÙˆØ±Ø© ØªØ¹Ø·ÙŠÙ„'.", event.threadID, event.messageID);
    }
};
